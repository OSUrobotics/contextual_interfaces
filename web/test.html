<html>
  <head>
    <meta content="text/html; charset=windows-1252" http-equiv="content-type">
    <script src="eventemitter2.min.js"></script>
    <script src="roslib.min.js"></script>
    <link rel="stylesheet" type="text/css" href="accordion.css">
    <script src="jquery-1.11.1.min.js"></script>
    <script src="scripts/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
    <!-- <link rel="stylesheet" href="scripts/jquery.onoff.css"> -->
    <!-- // <script src="scripts/jquery.onoff.min.js" type="text/javascript"></script> -->

    <link rel="stylesheet" href="scripts/jqwidgets/styles/jqx.base.css" type="text/css" />
    <link rel="stylesheet" href="scripts/jqwidgets/styles/jqx.classic.css" type="text/css" />
    <script type="text/javascript" src="scripts/jqwidgets/jqxcore.js"></script>
    <script type="text/javascript" src="scripts/jqwidgets/jqxswitchbutton.js"></script>
    <script type="text/javascript" src="scripts/jqwidgets/jqxbuttons.js"></script>
    <script type="text/javascript" src="scripts/jqwidgets/jqxbuttongroup.js"></script>
    <script type="text/javascript" src="scripts/jqwidgets/jqxdata.js"></script>
    <script type="text/javascript" src="scripts/jqwidgets/jqxscrollbar.js"></script>
    <script type="text/javascript" src="scripts/jqwidgets/jqxlistbox.js"></script>


    <script src="scripts/widgets.js"></script>
    <script src="scripts/peac.js"></script>
    <script src="scripts/monitor.js"></script>

    <link rel="stylesheet" type="text/css" href="controls.css">
    <script>

var controlData;
var mutexDevices;
var locationReady = false;

var nurse_call_device = {
    "device":{"deviceId":1950,"name":"Nurse Call"},
    "controlId":5392,
    "numVal":0,
    "name":"Nurse Call",
    "zone":"ALL"
}

$(document).ready(function() {
    mst = new MovementStartTrigger(function() {
        msg = {
            caption: 'MOVEMENT_START',
            interface: 'WEB_CONTEXT'
        }
        return // TODO remove this
        actuatedClient.callService(new ROSLIB.ServiceRequest({
            actuation: msg
        }), function(resp){})
    })
    $('body').click(mst.reset)


    $.getJSON('data/controls.json', function(data) {
        controlData = data
        call = $('<div>').device({
            device: nurse_call_device.device,
            controls: [nurse_call_device],
            controlData: controlData
        })
        call.attr('id', 'nurse-call')
        $('#location-selector').prepend(call)
    })
    $.getJSON('data/mutex.json', function(data) {
        mutexDevices = data
    })

    $("#locations").jqxListBox({
        width: "100%",
        autoHeight:true,
        // multiple: true,
        itemHeight: 50
    })
    updateLocationBox()
    // transitionListener.subscribe(transitionCallback)
    console.log(controlData)

})


var ros = new ROSLIB.Ros({
    url : 'ws://localhost:9090'
    // url : 'ws://192.168.0.12:9090'
});
ros.socket.onclose = function(obj) {
    console.log('Connection closed')
    console.log(obj)
}

// heartbeatListen(ros)

ros.on('connection', function() {
    console.log('Connected to websocket server.');
});
var transitionListener = new ROSLIB.Topic({
    ros: ros,
    name: '/transition',
    messageType: 'privacy_zones/Transition'
});

var getControlsClient = new ROSLIB.Service({
    ros: ros,
    name: '/get_devices_in_zone',
    serviceType: 'privacy_zones/DevicesInZone'
});

var updateControlClient = new ROSLIB.Service({
    ros: ros,
    name: '/peac/update_control',
    serviceType: 'peac_bridge/UpdateControl'
});

var listLocationsClient = new ROSLIB.Service({
    ros: ros,
    name: '/get_zone_locations',
    serviceType: 'privacy_zones/GetZoneLocations'
})

var zoneLocalizationClient = new ROSLIB.Service({
    ros: ros,
    name: '/localize_in_zone',
    serviceType: 'privacy_zones/LocalizeInZone'
})

var actuatedClient = new ROSLIB.Service({
    ros: ros,
    name: '/actuation_logging_server/report_control_actuated',
    serviceType: 'peac_bridge/ReportControlActuation'
})

var updateDeviceClient = new ROSLIB.Service({
    ros: ros,
    name: '/peac/get_device_info',
    serviceType: 'peac_bridge/get_device_info'
})

function wait(cond, action) {
    if(typeof(action)==='undefined') action = function() {}
    if (!cond()) {
        setTimeout(function () {
            return wait(cond, action)
        }, 100)
        console.log('WAITING')
    } else {
        console.log('DONE')
        return action()
    }
}

var last_zone = ''
var devicesIds = [];
var devices

function transitionCallback(msg) {
    request = new ROSLIB.ServiceRequest({zone : msg.zone.name, which: 0})
    // request = new ROSLIB.ServiceRequest({zone : msg.zone.name, which: 1})
    if(msg.action==1) { //enter
        console.log("Entered " + msg.zone.name)
        last_zone = msg.zone.name

        // get all the controls in this zone and add them
        getControlsClient.callService(request, function(resp) {
            devices = organizeByDevice(resp.controls)
            deviceIds = Object.keys(devices)
            specialDevices = mergeByType(devices, ['Door', 'Light'])
            mutexGroups = mergeMutex(devices, mutexDevices)

            // Add special devices grouped by type, not device (doors, lights)
            for(var deviceId in specialDevices) {
                if(specialDevices[deviceId].length > 0) {
                    $("#"+deviceId).device({
                        device: {
                            name: deviceId + 's'
                        },
                        controls: specialDevices[deviceId],
                        controlData: controlData
                    }).show()
                }
            }

            // Add mutex groups (like AV stuff)
            mutexGroups.forEach(function(group) {
                $('<div>').appendTo('#main').device_mutex({
                    devices: group
                })
            })

            for(var deviceId in devices) {
                // skip the nurse call since that gets handled on its own
                if(deviceId!=1950) {
                    $('<div>').appendTo('#main').device({
                        device: devices[deviceId][0].device,
                        controls: devices[deviceId],
                        controlData: controlData
                    })
                }
            }

            // devices.forEach(function(device) {
            //     console.log(device)
            // })
            // $(resp.controls).each(function() {
            //     controlbox = makeControl(this);
            //     $("#main").append(controlBox);
            // })
        })

        // update the location select box
        var locationItems = $('#locations').jqxListBox('getItems')
        msg.peac_locations.forEach(function(loc) {
            // $('#locations > option[value='+loc.locationId+']').attr('selected', 'selected')
            // $('#locations').jqxListBox()
            for(var i=0; i<locationItems.length; i++) {
                if(locationItems[i].value.loc.locationId==loc.locationId) {
                    $('#locations').jqxListBox('selectIndex', i)
                }
            }
        })

    } else { //exit
        console.log("Exited " + msg.zone.name)

        msg.peac_locations.forEach(function(loc) {
            $('#locations > option[value='+loc.locationId+']').removeAttr('selected')
        })

        elem = $('.device[zone]')
        elem.each(function() {
            // don't remove controls that the use is hovering over
            if(!$(this).data('hover')) {
                console.log()
                if($(this).attr('id')=='Light' || $(this).attr('id')=='Door') {
                    $(this).device('destroy')
                    $(this).hide()
                } else {
                    if(Number($(this).attr('deviceid'))!=1950)
                        $(this).remove();
                }
            }
            else {
                // instead, wait until they're done
                $(this).bind('mouseleave.leftover', function() {
                    if(Number($(this).attr('deviceid'))!=1950)
                        $(this).remove();
                })
            }
        })
    }

    // now bind the monitor listeners
    $('.control').click(function() {
        console.log(this)
    })
}

function updateLocationBox() {
    listLocationsClient.callService({}, function(resp) {
        var selected = -1
        for(var i=0; i<resp.locations.length; i++) {
            loc = resp.locations[i]
            zone = resp.zones[i]
            console.log(zone.name + " " + (last_zone==zone.name))
            $("#locations").jqxListBox('addItem', {
                label: loc.name,
                value: {zone: zone, loc: loc}
            })
            if(last_zone==zone.name) selected = i
        }
        $("#locations").jqxListBox('addItem', {
            label: "Somewhere Else",
            value: {zone: {name: "NONE"}, loc: {locationId: -1}}
        })
        $("#locations").jqxListBox('selectIndex', selected)

        $("#locations").on('select', function(evt) {
            zone = evt.args.item.value.zone
            console.log(zone.name)
            zoneLocalizationClient.callService({zone: zone.name}, function(resp){})
            msg = {
                caption: 'ZONE_LOCALIZE: ' + zone.name,
                interface: 'WEB_CONTEXT'
            }
            actuatedClient.callService(new ROSLIB.ServiceRequest({
                actuation: msg
            }), function(resp){})
        })
        locationReady = true
        transitionListener.subscribe(transitionCallback)
    })
}

pollInteval = setInterval(function() {
    if(typeof(deviceIds) != 'undefined') {
        pollPeac(deviceIds, updateDeviceClient)
    }
}, 5000)
    </script>
    <body>
        <section id="main-container">
            <section id="door-lights">
                <div id="Light"></div>
                <div id="Door"></div>
            </section>
            <section id="main">
            </section>
        </section>
        <nav id="location-selector">
            <h1>Current Location</h1>
            <h2>(click to fix if incorrect)</h2>
            <div id="locations"></div>
        </nav>
    </body>
</html>
